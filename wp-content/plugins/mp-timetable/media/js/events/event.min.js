Registry.register("Event",function(t){"use strict";function e(){return{event_id:"",eventsData:{},init:function(){n.initTimePicker(),n.addEventButton(),n.initDeleteButtons(),n.initEditButtons(),n.initColorPicker(),n.initDatePicker(),n.columnRadioBox()},initTimePicker:function(){var e=Boolean(parseInt(t("#time_format").val()));t("#event_start").timepicker({showPeriod:e,showPeriodLabels:e,defaultTime:"00:00"}),t("#event_end").timepicker({showPeriod:e,showPeriodLabels:e,defaultTime:"00:00"})},initSlider:function(e,a){var i=_.isUndefined(a)?!1:Boolean(a),s=e.replace(/^\D+/g,"");t(e).carouFredSel({items:{visible:3},direction:"up",scroll:{items:1,easing:"swing",pauseOnHover:!0,onAfter:function(e){e.items.old.each(function(){t(this).removeClass("visible")}),e.items.visible.each(function(){t(this).addClass("visible")})}},auto:{play:i,timeoutDuration:3e3},prev:{button:"#mp_prev_button"+s},next:{button:"#mp_next_button"+s}}),t(e).trigger("currentVisible",function(t){t.addClass("visible")}),n.setColorSettings(e+" .mptt-colorized")},initDeleteButton:function(){var e=t("#events-list");e.find("li.event").find("i.operation-button.dashicons-no.dashicons").off("click").on("click",function(){e.find("li.event").length>1?t(this).parents("li.event").remove():e.remove()})},initColorPicker:function(e){_.isUndefined(e)&&(e="");var n=t(e+" input.clr-picker"),a=t(e+" input.regular-text");n.spectrum("destroy"),n.spectrum({preferredFormat:"rgb",showInput:!0,showAlpha:!0,allowEmpty:!0,palette:[["#000","#444","#666","#999","#ccc","#eee","#f3f3f3","#fff"],["#f00","#f90","#ff0","#0f0","#0ff","#00f","#90f","#f0f"],["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],["#c00","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],["#900","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],["#600","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]],showPalette:!0,show:function(e){t(this).val(e)},hide:function(e){var n=t(this).parents(".select-color");n.find(".regular-text").val(t(this).val())},change:function(e){var n=t(this).parents(".select-color");n.find('input:not([type="hidden"])').val(t(this).val())}}),a.off("keyup").on("keyup",function(){var e=t(this).parents(".select-color"),n=e.find(".clr-picker"),a=e.find(".regular-text").val(),i=e.find(".sp-preview-inner");i.css({"background-color":a}),n.spectrum("set",a)})},addEventButton:function(){t(document).on("click.admin","#add_mp_event",function(){t(this).hasClass("edit")?n.updateEventData():n.renderEventItem()})},initDeleteButtons:function(){t(document).on("click.admin","#events-list .delete-event-button",function(){var e=t(this).attr("data-id");n.deleteEvent(e)})},initEditButtons:function(){t(document).on("click.admin","#events-list .edit-event-button",function(){var e=t(this).attr("data-id"),a=t(this).parent().parent();t(this).parent().find(".spinner").addClass("is-active"),Registry._get("adminFunctions").wpAjax({controller:"events",action:"get_event_data",id:e},function(e){var i=t("#add_mp_event"),s=t("#events-list");s.find(".spinner").removeClass("is-active"),s.find(" tr").removeClass("active"),a.addClass("active"),t("#event_start").val(e.event_start),t("#event_end").val(e.event_end),t("#description").val(e.description),t("#user_id").val(e.user_id),t("#weekday_id").val(e.column_id),i.addClass("edit"),i.val("Update"),n.event_id=e.id},function(t){console.warn(t)})})},deleteEvent:function(e){Registry._get("adminFunctions").wpAjax({controller:"events",action:"delete",id:e},function(n){var a=t("#events-list").find('tr[data-id="'+e+'"]');a.length&&a.remove()},function(t){console.log(t)})},updateEventItem:function(){var e=t("#events-list").find('tr[data-id="'+n.event_id+'"]'),a=t("#user_id");e.find("td.event-column").text(t("#weekday_id").find("option:selected").text()),e.find("td.event-start").text(t("#event_start").val()),e.find("td.event-end").text(t("#event_end").val()),e.find("td.event-user-id").text("-1"===a.val()?"":a.find("option:selected").text()),e.find("td.event-description").text(t("#description").val()),n.event_id=null,t("#add_mp_event").removeClass("edit").val("Add New")},updateEventData:function(){var e=t("#add_event_table").find(".spinner");e.addClass("is-active"),Registry._get("adminFunctions").wpAjax({controller:"events",action:"update_event_data",data:{id:Registry._get("Event").event_id,event_start:t("#event_start").val(),event_end:t("#event_end").val(),description:t("#description").val(),user_id:t("#user_id").val(),weekday_ids:t("#weekday_id").val()}},function(){e.removeClass("is-active"),n.updateEventItem(),n.clearTable()},function(t){e.removeClass("is-active"),console.log(t)})},renderEventItem:function(){var e=t("#weekday_id"),a=t("#user_id"),i=e.find("option:selected").val(),s=t("#event_start"),d=t("#event_end"),o=t("#description"),r={tag:"tr",attrs:{},content:[{tag:"td",attrs:{style:"display:none;"},content:[{tag:"input",attrs:{type:"hidden",name:"event_data["+i+"][weekday_ids][]",value:i}},{tag:"input",attrs:{type:"hidden",name:"event_data["+i+"][event_start][]",value:s.val()}},{tag:"input",attrs:{type:"hidden",name:"event_data["+i+"][event_end][]",value:d.val()}},{tag:"input",attrs:{type:"hidden",name:"event_data["+i+"][description][]",value:o.val()}},{tag:"input",attrs:{type:"hidden",name:"event_data["+i+"][user_id][]",value:a.val()}}]},{tag:"td",attrs:{"class":"event-column"},content:[e.find("option:selected").text()]},{tag:"td",attrs:{"class":"event-start"},content:[s.val()]},{tag:"td",attrs:{"class":"event-end"},content:[d.val()]},{tag:"td",attrs:{"class":"event-description"},content:[o.val()]},{tag:"td",attrs:{"class":"event-user-id"},content:["-1"===a.val()?"":a.find("option:selected").text()]},{tag:"td",attrs:{},content:[]}]},c=Registry._get("adminFunctions").getHtml(r);t("#events-list").find("tbody").append(c),t(".events-list-wrapper").scrollTop(1e10),n.clearTable()},setEventHeight:function(e){var n=e.parent().outerHeight(),a=t("body"),i=e.height(),s=e.data("min-height"),d=e.find(".mptt-inner-event-content").height();e.css("position","").css("width","").css("min-height",""),a.hasClass("mprm_ie")?(d=e.css("height","").find(".mptt-inner-event-content").height(),e.height(i),s>=d?e.css("max-height",s):(e.css("height",""),e.css("max-height",d))):s>=d?e.css("min-height",s):e.css("min-height",d),i>n&&e.height(i)},recalculate_Height:function(e,n){var a=t(".mptt-event-container",e),i=a.length,s=0,d=0,o=e.height();t("body").hasClass("mprm_ie")?(s=o/(i>0?i:1),_.isUndefined(n)?t.each(a,function(){var e=t(this);if(e.height(s),_.isEmpty(e.data("min-height"))){var n=e.height();0===n?e.data("min-height",s):e.data("min-height",n)}e.css("top",d+"px"),e.removeClass("mptt-hidden"),d+=s}):n.height(s)):(s=100/(i>0?i:1),_.isUndefined(n)?t.each(a,function(){var e=t(this);e.height(s+"%"),_.isEmpty(e.data("min-height"))&&e.data("min-height",e.height()),e.css("top",d+"%"),e.removeClass("mptt-hidden"),d+=s}):n.height(s+"%"))},setEventsHeight:function(){var e=t(".mptt-shortcode-wrapper").find("table").find("td.event");t.each(e,function(){var e=t(this);n.recalculate_Height(e)})},setColorSettings:function(e){_.isUndefined(e)&&(e=".mptt-colorized");var a=t(e);t.each(a,function(){var e=t(this),a=e.attr("data-bg_hover_color"),i=e.attr("data-hover_color"),s=e.parent();switch(e.attr("data-type")){case"column":case"event":e.hover(function(){_.isEmpty(a)||e.css("background-color",a),_.isEmpty(i)||e.css("color",i),n.setEventHeight(e)},function(){e.css("max-height","").css("min-height",""),n.recalculate_Height(s,e),e.css("background-color",e.attr("data-bg_color")),e.css("color",e.attr("data-color"))});break;case"widget":e.hover(function(){e.css("background-color",e.attr("data-background-hover-color")),e.css("color",t(this).attr("data-hover-color")),e.css("border-left-color",e.attr("data-hover-border-color"))},function(){e.css("background-color",e.attr("data-background-color")),e.css("color",e.attr("data-color")),e.css("border-left-color",e.attr("data-border-color"))})}})},clearTable:function(){var e=t("#weekday_id");t("#add_event_table input:not(.button),#add_event_table textarea").val(""),e.val(e.find("option:first").attr("value"))},getRowSpan:function(e){var n=[],a=[];t.each(e,function(e){var i=t(this).attr("data-start"),s=t(this).attr("data-end");a[e]=i,n[e]=s});var i=Math.min.apply(Math,a),s=Math.max.apply(Math,n),d=s-i;return 1>d?1:d},responsiveFilter:function(e){var n="all",a=e.parents(".mptt-shortcode-wrapper");n=e.is("select")?e.val():e.attr("href").replace("#","");var i=a.find(".mptt-list-event");"all"!==n?(i.hide(),a.find('.mptt-list-event[data-event-id="'+n+'"]').show()):i.show(),t.each(a.find(".mptt-column"),function(){t(this).show(),t(this).find(".mptt-list-event:visible").length<1&&t(this).hide()})},filterStatic:function(t){var e=t.parents(".mptt-shortcode-wrapper"),a="#all";a=t.is("select")?t.val():t.attr("href").replace("#","");var i=_.isEmpty(e.attr("id"))?"not-set":e.attr("id");window.location.hash=i+":"+a,e.find("table").hide(),e.find('table[id="#'+a+'"]').fadeIn(),n.setEventsHeight()},setClassTd:function(){t.each(t(".mptt-event-container"),function(){t(this).parents("td").addClass("event")})},initTableData:function(){n.setClassTd(),n.setRowSpanTd();var e="."+MPTT.table_class;t(e).data("hide_empty_row")&&n.hideEmptyRows()},filterShortcodeEvents:function(){var e=t(".mptt-menu");e.length&&(e.off("change").on("change",function(){n.filterStatic(t(this)),n.responsiveFilter(t(this))}),t(".mptt-navigation-tabs.mptt-menu a").off("click").on("click",function(){var e=t(this);e.parents(".mptt-navigation-tabs.mptt-menu").find("li").removeClass("active"),e.parents("li").addClass("active"),n.filterStatic(e),n.responsiveFilter(e)}))},showCurrentEvent:function(t,e){t.find(".mptt-menu").hasClass("mptt-navigation-tabs")?t.find(".mptt-navigation-tabs").find('a[href="#'+e+'"]').click():t.find(".mptt-menu").hasClass("mptt-navigation-select")&&t.find('.mptt-navigation-select option[value="'+e+'"]')?t.find(".mptt-navigation-select").val(e).change():t.find('table[id="#all"]').fadeIn()},getFilterByHash:function(){var e=1,a=window.location.hash;if(!_.isUndefined(a)){var i=a.split(":"),s=i[0],d=i[1],o=t(".mptt-shortcode-wrapper");d=_.isUndefined(d)?"all":d,o.length===e?n.showCurrentEvent(o,d):t.each(o,function(e,a){var i=t(a),o="#"+i.attr("id");o===s?n.showCurrentEvent(i,d):n.showCurrentEvent(i,"all")})}n.setEventsHeight()},removeCellsAfterChangeColSpan:function(t,e,n,a){for(t;e>t;t++){var i=n.find('th[data-index="'+t+'"]').data("column-id");a.find('td:not(.event)[data-column-id="'+i+'"]').remove()}},removeCellsAfterChangeRowSpan:function(t,e,a,i){var s=t.parents("tr").attr("data-index"),d=e+parseInt(s)-1,o=t.attr("colspan"),r=a.find('th[data-column-id="'+i+'"]').data("index"),c=parseInt(r)+parseInt(o);for(s;d>s;s++){var l=a.find("tr.mptt-shortcode-row-"+(parseInt(s)+1));if(l.length){if(l.find('td.event[data-column-id="'+i+'"]').length&&(e-=d-s,2>e)){e=1;break}o>1&&n.removeCellsAfterChangeColSpan(r,c,a,l),l.find('td:not(.event)[data-column-id="'+i+'"]').remove()}}return e},setRowSpanTd:function(){var e="."+MPTT.table_class;t.each(t(e),function(){var e=t(this);t.each(e.find("td.event"),function(){var a=t(this),i=a.find(".mptt-event-container"),s=a.attr("data-column-id"),d=a.attr("data-row_height"),o=n.getRowSpan(i);!_.isUndefined(o)&&o>1&&(o=n.removeCellsAfterChangeRowSpan(a,o,e,s),isNaN(d)||a.css("height",o*d)),a.attr("rowspan",o)})})},hideEmptyRows:function(){var e="."+MPTT.table_class,n=t(e+" tbody tr"),a=t(e).first().find("th").length;t.each(n,function(e,n){0===t(n).find("td.event").length&&t(n).find("td").length===a&&t(n).remove()})},displaySettings:function(){var e=t(".view_settings");e.length&&e.change(function(){if("all"===t(this).val()){t(this).attr("id");t(this).parents(".mptt-container").find(".next-days").css("display","block")}else t(this).parents(".mptt-container").find(".next-days").css("display","none")})},timeMode:function(e){if(e){var n="."+t(this).attr("id");t("#"+e).change(function(){if("server"===t(this).val()){t(this).attr("id");t(this).parents(".mptt-container").find(n).css("display","block")}else t(this).parents(".mptt-container").find(n).css("display","none")})}},initDatePicker:function(){var e=t("#datepicker");e.length&&e.datepicker({dateFormat:"d/m/yy",setDate:Date.parse(e.val())})},columnRadioBox:function(){var e=t("#datepicker"),n=t('input.option-input[name="column[column_option]"]'),a=t("select.mp-weekday");n.length&&n.on("change",function(){switch(t(this).val()){case"simple":a.prop("disabled",!0),e.prop("disabled",!0);break;case"weekday":a.prop("disabled",!1),e.val("").prop("disabled",!0);break;case"date":a.prop("disabled",!0),e.prop("disabled",!1)}})}}}var n;return{getInstance:function(){return n||(n=e()),n}}}(jQuery));